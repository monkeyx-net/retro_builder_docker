name: Build Optimized Ubuntu 20.04 Docker Image on ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04-arm

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/arm64
        driver: docker-container

    - name: Build with native optimization
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/arm64
        tags: ubuntu20.04-arm:latest
        outputs: type=docker,dest=/tmp/image.tar
        build-args: |
          DEBIAN_FRONTEND=noninteractive
          BUILDKIT_INLINE_CACHE=1
        # No manual squash needed - optimize in Dockerfile instead

    - name: Load and verify image
      run: |
        docker load -i /tmp/image.tar

        echo "=== Testing basic functionality ==="
        docker run --rm ubuntu20.04-arm:latest uname -a
        docker run --rm ubuntu20.04-arm:latest cat /etc/os-release

        echo "=== Checking package versions ==="
        docker run --rm ubuntu20.04-arm:latest python3 --version
        docker run --rm ubuntu20.04-arm:latest cmake --version

        echo "=== Checking for upgradable packages ==="
        docker run --rm ubuntu20.04-arm:latest bash -c "apt-get update && apt list --upgradable | head -10"

    - name: Test SDL installation
      run: |
        echo "=== Testing SDL installation ==="
        docker run --rm ubuntu20.04-arm:latest pkg-config --modversion sdl2

        echo "=== Testing SDL compilation ==="
        docker run --rm ubuntu20.04-arm:latest bash -c "
          cat > /tmp/test-sdl.c << 'EOF'
          #include <SDL2/SDL.h>
          #include <stdio.h>
          int main() {
              printf('SDL compiled successfully: %d.%d.%d\\n',
                     SDL_MAJOR_VERSION, SDL_MINOR_VERSION, SDL_PATCHLEVEL);
              return 0;
          }
          EOF
          gcc /tmp/test-sdl.c -o /tmp/test-sdl \$(pkg-config --cflags --libs sdl2) && /tmp/test-sdl
        "

    - name: Image size analysis
      run: |
        echo "=== Image size analysis ==="
        SIZE=$(docker image inspect ubuntu20.04-arm:latest --format='{{.Size}}')
        SIZE_GB=$(echo "scale=2; $SIZE / 1024 / 1024 / 1024" | bc)
        echo "Final image size: ${SIZE_GB}GB"

        if (( $(echo "$SIZE_GB > 2.5" | bc -l) )); then
          echo "⚠️  Warning: Image size is larger than 2.5GB"
          echo "Consider optimizing your Dockerfile further"
        else
          echo "✅ Image size is acceptable"
        fi
