name: Build Ubuntu 20.04 Docker Image on ARM64

on:
  push:
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-22.04-arm64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        platforms: linux/arm64

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/arm64
        load: true
        tags: ubuntu20.04-arm64:latest
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

    - name: Test built image
      run: |
        echo "Testing the built Docker image..."
        docker run --rm ubuntu20.04-arm64:latest uname -a
        docker run --rm ubuntu20.04-arm64:latest cat /etc/os-release
        docker run --rm ubuntu20.04-arm64:latest python3 --version
        docker run --rm ubuntu20.04-arm64:latest cmake --version
        echo "All tests passed!"

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

  test:
    runs-on: ubuntu-22.04-arm64
    needs: build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Load and run additional tests
      run: |
        # Test SDL installation
        docker run --rm ubuntu20.04-arm64:latest bash -c "pkg-config --modversion sdl2"

        # Test basic compilation
        docker run --rm -v $PWD/test-sdl.c:/tmp/test-sdl.c ubuntu20.04-arm64:latest bash -c "
          cat > /tmp/test-sdl.c << 'EOF'
          #include <SDL2/SDL.h>
          #include <stdio.h>
          int main() {
              printf('SDL compiled successfully: %d.%d.%d\n',
                     SDL_MAJOR_VERSION, SDL_MINOR_VERSION, SDL_PATCHLEVEL);
              return 0;
          }
          EOF
          gcc /tmp/test-sdl.c -o /tmp/test-sdl $(pkg-config --cflags --libs sdl2) && /tmp/test-sdl
        "

    - name: Image size check
      run: |
        SIZE=$(docker image inspect ubuntu20.04-arm64:latest --format='{{.Size}}')
        SIZE_GB=$(echo "scale=2; $SIZE / 1024 / 1024 / 1024" | bc)
        echo "Image size: ${SIZE_GB}GB"
        if (( $(echo "$SIZE_GB > 3" | bc -l) )); then
          echo "Warning: Image size is larger than 3GB"
        else
          echo "Image size is acceptable"
        fi
